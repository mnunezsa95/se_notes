* Inbound Server data can validated by defining the mongoose model schema (see [[MongoDB - Schemas & Models]])
	* Makes app vulnerable to DDoS attacks (see [[Distributed Denial of Service (DDoS)]])
	* Schema validation only runs when the controller code runs. 
		* Controller code can crash if the client sends the wrong request body

# Validating an incoming request
* Validate the incoming request --> if the client does NOT send what is expected, the controller will not start client will receive an error
	* Can be done using 2 libraries: **joi** and **celebrate** (see [[Node.js - Module - 'joi' and 'celebrate']])

#### Example: using Joi
* Code rundown
	1) `body` must be an object with keys
	2) `email` is a string, required field, and must match email pattern
	3) `password` is a string, required field, and must be at least 8 chars
	4) `name` is a string, required field and must be between 2 and 30 chars
	5) `age` is a number, must be an integer, is required and must be atleast 18
	6) `about` is a string from 2 to 30 chars
```js
{
	body: Joi.object().keys({
	    email: Joi.string().required().email(),
	    password: Joi.string().required().min(8),
	    name: Joi.string().required().min(2).max(30),
	    age: Joi.number().integer().required().min(18),
	    about: Joi.string().min(2).max(30),
	})
} 
```

#### Example: using celebrate
* MUST be connected as a middleware
```js
const { celebrate, Joi } = require("celebrate");

router.post('/posts', celebrate({ 
	body: Joi.object().keys({ 
		title: Joi.string().required().min(2).max(30), 
		text: Joi.string().required().min(2), 
	}), 
}), createPost);
```

#### celebrate: Validating headers, parameters or queries
* celebrate allows for headers, parameters or req.queries to be validated
* joi does not allow fields that are NOT listed in the validation object
	* call the `unknown(true)` method after calling the `keys()` method to change this behavior
```js
const { celebrate, Joi } = require('celebrate'); 

router.delete('/:postId', celebrate({ // validate parameters 
	params: Joi.object().keys({ 
		postId: Joi.string().alphanum().length(24), 
	}), 
	headers: Joi.object().keys({ 
		// validate headers 
	}).unknown(true),
	query: Joi.object().keys({ 
		// validate query 
	}), 
}), deletePost);
```

#### Error handling with JOI and Celebrate
* celebrate has a special `errors()` middleware for sending errors to the client
	* Will ONLY handle errors generated by celebrate
	* Passes any other error forward (where the centralized error handler can catch them)
* Example
```js
// app.js
const { errors } = require('celebrate');

// error handlers
app.use(errors()); // celebrate error handler

// our centralized handler
app.use((err, req, res, next) => {
  // ...
}); 
```

* The error status returned by celebrate is 400 (see [[Server Response Status Codes]]) 
	* The `message` field allows the client to understand what is wrong with their request.
	* Example: response body produced by celebrate
```js
"child \"name\" fails because [\"name\" is required]",{
    "statusCode": 400,
    "error": "Bad Request",
    "message": "child \"name\" fails because [\"name\" is required]",
    "validation": {
        "source": "body",
        "keys": [
            "name"
        ]
    }
} 
```

### Example: joi and celebrate in a project
```js
const validateUserInfo = celebrate({
	body: Joi.object().keys({
		name: Joi.string().required().min(2).max(30).messages({
			"string.min": 'The minimum length of the "name" field is 2',
			"string.max": 'The maximum length of the "name" field is 30',
		    "string.empty": 'The "name" field must be filled in',
	    }),
	    avatar: Joi.string().required().custom(validateURL).messages({
		    "string.empty": 'The "imageUrl" field must be filled in',
		    "string.uri": 'The "imageUrl" field must be a valid url',
	    }),
	    email: Joi.string().required().email().message({
		    "string.empty": 'The "email" field must be filled in',
		    "string.email": 'The "email" field must be a valid email',
	    }),
		password: Joi.string().required().messages({
		    "password.empty": 'The "password" field must be filled in',
	    }),
	}),
});
```
